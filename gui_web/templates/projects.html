<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Projects</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
      /* Responsive modal table: columns auto-width, no wrap, scroll if needed */
      #investment-modal-table-wrapper {
        width: 100%;
        overflow-x: auto;
      }
      #investment-modal-table table {
        table-layout: auto;
        width: auto;
        min-width: 600px;
        max-width: none;
      }
      #investment-modal-table th, #investment-modal-table td {
        white-space: nowrap;
        text-align: center;
        vertical-align: middle;
        min-width: 120px;
      }
      .modal-lg {
        max-width: 95vw;
      }
      /* Also apply to tabbed project tables */
      .investment-tab-table-wrapper {
        width: 100%;
        overflow-x: auto;
      }
      .investment-tab-table {
        table-layout: auto;
        width: auto;
        min-width: 600px;
        max-width: none;
      }
      .investment-tab-table th, .investment-tab-table td {
        white-space: nowrap;
        text-align: center;
        vertical-align: middle;
        min-width: 200px; /* Further increased for full data display */
      }
      .investment-tab-table input.form-control {
        width: 100%;
        min-width: 200px;
        display: block;
        box-sizing: border-box;
      }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>Projects</h1>
        <a href="/" class="btn btn-secondary mt-3">&larr; Back to Home</a>
        <p class="mt-4">This is a placeholder for the Projects page.</p>
        <button class="btn btn-primary mt-4" data-bs-toggle="modal" data-bs-target="#searchModal">Search Projects</button>
    </div>

    <!-- Tabbed project view -->
    <div class="container mt-4">
      <ul class="nav nav-tabs" id="projectTabs" role="tablist"></ul>
      <div class="tab-content" id="projectTabContent"></div>
    </div>

    <!-- Search Modal with fields -->
    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="searchModalLabel">Search Projects</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="search-projects-form">
              {% for field in project_fields %}
                <div class="mb-3">
                  <label for="search-{{ field }}" class="form-label">{{ field.replace('_', ' ').title() }}</label>
                  <input type="text" class="form-control" id="search-{{ field }}" name="{{ field }}" placeholder="Enter {{ field.replace('_', ' ').title() }}">
                </div>
              {% endfor %}
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="search-projects-btn">Search</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="resultsModalLabel">Search Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="select-projects-form">
              <div id="search-results-container">
                <!-- Results will be injected here -->
              </div>
              <button type="submit" class="btn btn-primary mt-3">Open Selected</button>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Investment/Depreciation Edit Modal -->
    <div class="modal fade" id="investmentModal" tabindex="-1" aria-labelledby="investmentModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="investmentModalLabel">Edit Investments & Depreciation</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="investment-modal-form">
              <div id="investment-modal-table-wrapper">
                <div id="investment-modal-table"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="save-investment-modal-btn">Save</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Make project_fields available in JS (Jinja2 block for correct placement)
    var projectFields = {{ project_fields | tojson | safe }};

    // Search and display results with checkboxes
    document.getElementById('search-projects-btn').addEventListener('click', function() {
      const form = document.getElementById('search-projects-form');
      const formData = new FormData(form);
      const params = new URLSearchParams();
      for (const [key, value] of formData.entries()) {
        params.append(key, value);
      }
      fetch(`/search-projects?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          let html = '';
          if (!Array.isArray(data) || data.length === 0) {
            html = '<div class="alert alert-warning">No projects found.</div>';
          } else {
            html += '<table class="table table-bordered"><thead><tr><th></th>';
            projectFields.forEach(function(field) {
              html += `<th>${field.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`;
            });
            html += '</tr></thead><tbody>';
            data.forEach(function(proj) {
              if (typeof proj !== 'object' || proj === null) return;
              html += '<tr>';
              html += `<td><input type="checkbox" name="project_id" value="${proj.project_id ?? proj['project_id'] ?? ''}"></td>`;
              projectFields.forEach(function(field) {
                html += `<td>${proj[field] ?? ''}</td>`;
              });
              html += '</tr>';
            });
            html += '</tbody></table>';
          }
          document.getElementById('search-results-container').innerHTML = html;
          // Hide the search modal only after results are ready
          const searchModal = bootstrap.Modal.getInstance(document.getElementById('searchModal'));
          if (searchModal) searchModal.hide();
          const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
          resultsModal.show();
        })
        .catch(err => {
          document.getElementById('search-results-container').innerHTML = '<div class="alert alert-danger">Error fetching results: ' + err + '</div>';
          const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
          resultsModal.show();
        });
    });

    // Handle opening selected projects in tabs
    document.getElementById('select-projects-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const checked = Array.from(document.querySelectorAll('#search-results-container input[name="project_id"]:checked')).map(cb => cb.value);
      if (checked.length === 0) {
        alert('No projects selected.');
        return;
      }
      // For each selected project, fetch details and open in a tab
      checked.forEach(projectId => {
        openProjectTab(projectId);
      });
      // Close results modal
      const resultsModal = bootstrap.Modal.getInstance(document.getElementById('resultsModal'));
      if (resultsModal) resultsModal.hide();
    });

    // Tab management
    function openProjectTab(projectId) {
      // If tab already exists, activate it
      if (document.getElementById('tab-' + projectId)) {
        const tab = new bootstrap.Tab(document.getElementById('tab-' + projectId));
        tab.show();
        return;
      }
      // Fetch project details (reuse search endpoint for demo, ideally have a /project/<id> endpoint)
      fetch(`/search-projects?project_id=${projectId}`)
        .then(response => response.json())
        .then(data => {
          const proj = Array.isArray(data) ? data[0] : data;
          if (!proj) return;
          // Add tab
          const tabId = 'tab-' + projectId;
          const contentId = 'tab-content-' + projectId;
          const tabList = document.getElementById('projectTabs');
          const tabContent = document.getElementById('projectTabContent');
          // Tab
          const tabLi = document.createElement('li');
          tabLi.className = 'nav-item';
          tabLi.innerHTML = `<button class="nav-link" id="${tabId}" data-bs-toggle="tab" data-bs-target="#${contentId}" type="button" role="tab" aria-controls="${contentId}" aria-selected="false">Project ${proj.project_id} <span class="ms-2 text-danger" style="cursor:pointer;" onclick="closeProjectTab('${projectId}')">&times;</span></button>`;
          tabList.appendChild(tabLi);
          // Content
          const tabPane = document.createElement('div');
          tabPane.className = 'tab-pane fade';
          tabPane.id = contentId;
          tabPane.setAttribute('role', 'tabpanel');
          tabPane.innerHTML = `
            <form class="mt-3" onsubmit="saveProject(event, '${projectId}')">
              <div class="mb-3"><label>Project Id</label><input class="form-control" name="project_id" value="${proj.project_id}" readonly></div>
              <div class="mb-3"><label>Branch</label><input class="form-control" name="branch" value="${proj.branch ?? ''}"></div>
              <div class="mb-3"><label>Operations</label><input class="form-control" name="operations" value="${proj.operations ?? ''}"></div>
              <div class="mb-3"><label>Description</label><input class="form-control" name="description" value="${proj.description ?? ''}"></div>
              <div class="mb-3"><label>Depreciation Method</label><input class="form-control" name="depreciation_method" value="${proj.depreciation_method ?? ''}"></div>
              <hr>
              <h5>Investments & Depreciation Starts</h5>
              <div id="investment-table-${projectId}"></div>
              <button type="button" class="btn btn-outline-primary mt-2" onclick="openInvestmentModal('${projectId}')">Edit Investments/Depreciation</button>
              <button type="submit" class="btn btn-success mt-3 ms-2">Save Changes</button>
              <button type="button" class="btn btn-danger ms-2" onclick="deleteProject('${projectId}')">Delete Project</button>
            </form>
          `;
          tabContent.appendChild(tabPane);
          // Fetch investments and render table
          fetch(`/project-investments/${projectId}`)
            .then(response => response.json())
            .then(investments => {
              renderInvestmentTableForProject(projectId, investments, true); // true = read-only
            });
          // Activate new tab
          const tab = new bootstrap.Tab(document.getElementById(tabId));
          tab.show();
        });
    }

    // Close tab function
    window.closeProjectTab = function(projectId) {
      const tabId = 'tab-' + projectId;
      const contentId = 'tab-content-' + projectId;
      const tabBtn = document.getElementById(tabId);
      const tabPane = document.getElementById(contentId);
      if (tabBtn) tabBtn.parentElement.remove();
      if (tabPane) tabPane.remove();
      // Optionally, activate another tab if any
      const firstTab = document.querySelector('#projectTabs .nav-link');
      if (firstTab) {
        const tab = new bootstrap.Tab(firstTab);
        tab.show();
      }
    }

    // Save project changes (placeholder, implement backend as needed)
    window.saveProject = function(event, projectId) {
      event.preventDefault();
      const form = event.target;
      const data = Object.fromEntries(new FormData(form).entries());
      // TODO: Implement backend update endpoint
      alert('Saving project ' + projectId + ':\n' + JSON.stringify(data, null, 2));
    }

    // Delete project (placeholder, implement backend as needed)
    window.deleteProject = function(projectId) {
      if (!confirm('Are you sure you want to delete project ' + projectId + '?')) return;
      // TODO: Implement backend delete endpoint
      alert('Deleting project ' + projectId);
      closeProjectTab(projectId);
    }

    // Investment & Depreciation Table for Project Tab
    function renderInvestmentTableForProject(projectId, investments = [], readOnly = false) {
      const years = investments.years || investments.years || [];
      const data = investments.investments || investments || [];
      const invMap = {};
      const deprStartMap = {};
      const deprMonthMap = {};
      data.forEach(inv => {
        if (inv.investment_amount !== undefined && inv.investment_amount !== null) {
          invMap[inv.year] = inv.investment_amount;
        }
        if (inv.start_year !== undefined && inv.start_year !== null) {
          deprStartMap[inv.year] = true;
          if (inv.month !== undefined && inv.month !== null) {
            deprMonthMap[inv.year] = inv.month;
          }
        }
      });
      let html = '<div class="investment-tab-table-wrapper">';
      html += '<table class="table table-bordered text-center investment-tab-table">';
      html += '<thead><tr>';
      years.forEach(year => {
        html += `<th>${year}</th>`;
      });
      html += '</tr></thead><tbody>';
      // Investment row
      html += '<tr>';
      years.forEach(year => {
        html += `<td><input type="number" class="form-control" name="investment_${year}" placeholder="Investment" value="${invMap[year] ?? ''}" ${readOnly ? 'readonly tabindex="-1"' : ''}></td>`;
      });
      html += '</tr>';
      // Depreciation start year row (tickboxes)
      html += '<tr>';
      years.forEach(year => {
        html += `<td><input type="checkbox" class="form-check-input" name="depr_start_${year}" ${deprStartMap[year] ? 'checked' : ''} ${readOnly ? 'disabled tabindex="-1"' : ''}></td>`;
      });
      html += '</tr>';
      // Depreciation start month row (input only if ticked)
      html += '<tr>';
      years.forEach(year => {
        html += `<td id="month-cell-${projectId}-${year}">`;
        if (deprStartMap[year]) {
          html += `<input type="number" min="1" max="12" class="form-control" name="depr_month_${year}" placeholder="Month" value="${deprMonthMap[year] ?? ''}" ${readOnly ? 'readonly tabindex="-1"' : ''}>`;
        }
        html += '</td>';
      });
      html += '</tr>';
      html += '</tbody></table></div>';
      document.getElementById(`investment-table-${projectId}`).innerHTML = html;
    }
    window.toggleMonthInputForProject = function(projectId, year, checked) {
      const cell = document.getElementById(`month-cell-${projectId}-${year}`);
      if (checked) {
        cell.innerHTML = `<input type="number" min="1" max="12" class="form-control" name="depr_month_${year}" placeholder="Month">`;
      } else {
        cell.innerHTML = '';
      }
    }

    // Modal logic
    window.openInvestmentModal = function(projectId) {
      // Fetch data and populate modal
      fetch(`/project-investments/${projectId}`)
        .then(response => response.json())
        .then(data => {
          renderInvestmentModalTable(projectId, data);
          // Store projectId for save
          document.getElementById('investmentModal').setAttribute('data-project-id', projectId);
          const modal = new bootstrap.Modal(document.getElementById('investmentModal'));
          modal.show();
        });
    }
    // In renderInvestmentModalTable, set table id for CSS
    function renderInvestmentModalTable(projectId, data) {
      const years = data.years || [];
      const investments = data.investments || [];
      const invMap = {};
      const deprStartMap = {};
      const deprMonthMap = {};
      investments.forEach(inv => {
        if (inv.investment_amount !== undefined && inv.investment_amount !== null) {
          invMap[inv.year] = inv.investment_amount;
        }
        if (inv.start_year !== undefined && inv.start_year !== null) {
          deprStartMap[inv.year] = true;
          if (inv.month !== undefined && inv.month !== null) {
            deprMonthMap[inv.year] = inv.month;
          }
        }
      });
      let html = '<table class="table table-bordered text-center" id="investment-modal-table-table"><thead><tr>';
      years.forEach(year => {
        html += `<th>${year}</th>`;
      });
      html += '</tr></thead><tbody>';
      // Investment row
      html += '<tr>';
      years.forEach(year => {
        html += `<td><input type="number" class="form-control" name="investment_${year}" placeholder="Investment" value="${invMap[year] ?? ''}"></td>`;
      });
      html += '</tr>';
      // Depreciation start year row (tickboxes)
      html += '<tr>';
      years.forEach(year => {
        html += `<td><input type="checkbox" class="form-check-input" name="depr_start_${year}" onchange="toggleMonthInputModal(${year}, this.checked)" ${deprStartMap[year] ? 'checked' : ''}></td>`;
      });
      html += '</tr>';
      // Depreciation start month row (input only if ticked)
      html += '<tr>';
      years.forEach(year => {
        html += `<td id="modal-month-cell-${year}">`;
        if (deprStartMap[year]) {
          html += `<input type="number" min="1" max="12" class="form-control" name="depr_month_${year}" placeholder="Month" value="${deprMonthMap[year] ?? ''}">`;
        }
        html += '</td>';
      });
      html += '</tr>';
      html += '</tbody></table>';
      document.getElementById('investment-modal-table').innerHTML = html;
    }
    window.toggleMonthInputModal = function(year, checked) {
      const cell = document.getElementById(`modal-month-cell-${year}`);
      if (checked) {
        cell.innerHTML = `<input type="number" min="1" max="12" class="form-control" name="depr_month_${year}" placeholder="Month">`;
      } else {
        cell.innerHTML = '';
      }
    }

    // Save button handler (ready for backend integration)
    document.getElementById('save-investment-modal-btn').addEventListener('click', function() {
      const form = document.getElementById('investment-modal-form');
      const data = Object.fromEntries(new FormData(form).entries());
      const projectId = document.getElementById('investmentModal').getAttribute('data-project-id');
      // TODO: Send data to backend endpoint for saving
      alert('Saving investments for project ' + projectId + ':\n' + JSON.stringify(data, null, 2));
      // Optionally close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('investmentModal'));
      if (modal) modal.hide();
      // Refresh the tab table if open
      const tabTableDiv = document.getElementById(`investment-table-${projectId}`);
      if (tabTableDiv) {
        fetch(`/project-investments/${projectId}`)
          .then(response => response.json())
          .then(investments => {
            renderInvestmentTableForProject(projectId, investments, true);
          });
      }
    });
    </script>
</body>
</html>
