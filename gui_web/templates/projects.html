<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Projects</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Projects</h1>
        <a href="/" class="btn btn-secondary mt-3">&larr; Back to Home</a>
        <p class="mt-4">This is a placeholder for the Projects page.</p>
        <button class="btn btn-primary mt-4" data-bs-toggle="modal" data-bs-target="#searchModal">Search Projects</button>
    </div>

    <!-- Tabbed project view -->
    <div class="container mt-4">
      <ul class="nav nav-tabs" id="projectTabs" role="tablist"></ul>
      <div class="tab-content" id="projectTabContent"></div>
    </div>

    <!-- Search Modal with fields -->
    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="searchModalLabel">Search Projects</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="search-projects-form">
              {% for field in project_fields %}
                <div class="mb-3">
                  <label for="search-{{ field }}" class="form-label">{{ field.replace('_', ' ').title() }}</label>
                  <input type="text" class="form-control" id="search-{{ field }}" name="{{ field }}" placeholder="Enter {{ field.replace('_', ' ').title() }}">
                </div>
              {% endfor %}
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="search-projects-btn">Search</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="resultsModalLabel">Search Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="select-projects-form">
              <div id="search-results-container">
                <!-- Results will be injected here -->
              </div>
              <button type="submit" class="btn btn-primary mt-3">Open Selected</button>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Make project_fields available in JS (Jinja2 block for correct placement)
    var projectFields = {{ project_fields|tojson|safe }};

    // Search and display results with checkboxes
    document.getElementById('search-projects-btn').addEventListener('click', function() {
      const form = document.getElementById('search-projects-form');
      const formData = new FormData(form);
      const params = new URLSearchParams();
      for (const [key, value] of formData.entries()) {
        params.append(key, value);
      }
      fetch(`/search-projects?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          let html = '';
          if (!Array.isArray(data) || data.length === 0) {
            html = '<div class="alert alert-warning">No projects found.</div>';
          } else {
            html += '<table class="table table-bordered"><thead><tr><th></th>';
            projectFields.forEach(function(field) {
              html += `<th>${field.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`;
            });
            html += '</tr></thead><tbody>';
            data.forEach(function(proj) {
              if (typeof proj !== 'object' || proj === null) return;
              html += '<tr>';
              html += `<td><input type="checkbox" name="project_id" value="${proj.project_id ?? proj['project_id'] ?? ''}"></td>`;
              projectFields.forEach(function(field) {
                html += `<td>${proj[field] ?? ''}</td>`;
              });
              html += '</tr>';
            });
            html += '</tbody></table>';
          }
          document.getElementById('search-results-container').innerHTML = html;
          // Hide the search modal only after results are ready
          const searchModal = bootstrap.Modal.getInstance(document.getElementById('searchModal'));
          if (searchModal) searchModal.hide();
          const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
          resultsModal.show();
        })
        .catch(err => {
          document.getElementById('search-results-container').innerHTML = '<div class="alert alert-danger">Error fetching results: ' + err + '</div>';
          const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
          resultsModal.show();
        });
    });

    // Handle opening selected projects in tabs
    document.getElementById('select-projects-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const checked = Array.from(document.querySelectorAll('#search-results-container input[name="project_id"]:checked')).map(cb => cb.value);
      if (checked.length === 0) {
        alert('No projects selected.');
        return;
      }
      // For each selected project, fetch details and open in a tab
      checked.forEach(projectId => {
        openProjectTab(projectId);
      });
      // Close results modal
      const resultsModal = bootstrap.Modal.getInstance(document.getElementById('resultsModal'));
      if (resultsModal) resultsModal.hide();
    });

    // Tab management
    function openProjectTab(projectId) {
      // If tab already exists, activate it
      if (document.getElementById('tab-' + projectId)) {
        const tab = new bootstrap.Tab(document.getElementById('tab-' + projectId));
        tab.show();
        return;
      }
      // Fetch project details (reuse search endpoint for demo, ideally have a /project/<id> endpoint)
      fetch(`/search-projects?project_id=${projectId}`)
        .then(response => response.json())
        .then(data => {
          const proj = Array.isArray(data) ? data[0] : data;
          if (!proj) return;
          // Add tab
          const tabId = 'tab-' + projectId;
          const contentId = 'tab-content-' + projectId;
          const tabList = document.getElementById('projectTabs');
          const tabContent = document.getElementById('projectTabContent');
          // Tab
          const tabLi = document.createElement('li');
          tabLi.className = 'nav-item';
          tabLi.innerHTML = `<button class="nav-link" id="${tabId}" data-bs-toggle="tab" data-bs-target="#${contentId}" type="button" role="tab" aria-controls="${contentId}" aria-selected="false">Project ${proj.project_id} <span class="ms-2 text-danger" style="cursor:pointer;" onclick="closeProjectTab('${projectId}')">&times;</span></button>`;
          tabList.appendChild(tabLi);
          // Content
          const tabPane = document.createElement('div');
          tabPane.className = 'tab-pane fade';
          tabPane.id = contentId;
          tabPane.setAttribute('role', 'tabpanel');
          tabPane.innerHTML = `
            <form class="mt-3" onsubmit="saveProject(event, '${projectId}')">
              <div class="mb-3"><label>Project Id</label><input class="form-control" name="project_id" value="${proj.project_id}" readonly></div>
              <div class="mb-3"><label>Branch</label><input class="form-control" name="branch" value="${proj.branch ?? ''}"></div>
              <div class="mb-3"><label>Operations</label><input class="form-control" name="operations" value="${proj.operations ?? ''}"></div>
              <div class="mb-3"><label>Description</label><input class="form-control" name="description" value="${proj.description ?? ''}"></div>
              <div class="mb-3"><label>Depreciation Method</label><input class="form-control" name="depreciation_method" value="${proj.depreciation_method ?? ''}"></div>
              <button type="submit" class="btn btn-success">Save Changes</button>
              <button type="button" class="btn btn-danger ms-2" onclick="deleteProject('${projectId}')">Delete Project</button>
            </form>
          `;
          tabContent.appendChild(tabPane);
          // Activate new tab
          const tab = new bootstrap.Tab(document.getElementById(tabId));
          tab.show();
        });
    }

    // Close tab function
    window.closeProjectTab = function(projectId) {
      const tabId = 'tab-' + projectId;
      const contentId = 'tab-content-' + projectId;
      const tabBtn = document.getElementById(tabId);
      const tabPane = document.getElementById(contentId);
      if (tabBtn) tabBtn.parentElement.remove();
      if (tabPane) tabPane.remove();
      // Optionally, activate another tab if any
      const firstTab = document.querySelector('#projectTabs .nav-link');
      if (firstTab) {
        const tab = new bootstrap.Tab(firstTab);
        tab.show();
      }
    }

    // Save project changes (placeholder, implement backend as needed)
    window.saveProject = function(event, projectId) {
      event.preventDefault();
      const form = event.target;
      const data = Object.fromEntries(new FormData(form).entries());
      // TODO: Implement backend update endpoint
      alert('Saving project ' + projectId + ':\n' + JSON.stringify(data, null, 2));
    }

    // Delete project (placeholder, implement backend as needed)
    window.deleteProject = function(projectId) {
      if (!confirm('Are you sure you want to delete project ' + projectId + '?')) return;
      // TODO: Implement backend delete endpoint
      alert('Deleting project ' + projectId);
      closeProjectTab(projectId);
    }
    </script>
</body>
</html>
