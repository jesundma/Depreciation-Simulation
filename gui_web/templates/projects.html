<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Projects</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
      /* Responsive modal table: columns auto-width, no wrap, scroll if needed */
      #investment-modal-table-wrapper {
        width: 100%;
        overflow-x: auto;
      }
      #investment-modal-table table {
        table-layout: auto;
        width: auto;
        min-width: 600px;
        max-width: none;
      }
      #investment-modal-table th, #investment-modal-table td {
        white-space: nowrap;
        text-align: center;
        vertical-align: middle;
        min-width: 120px;
      }
      .modal-lg {
        max-width: 95vw;
      }
      /* Also apply to tabbed project tables */
      .investment-tab-table-wrapper {
        width: 100%;
        overflow-x: auto;
      }
      .investment-tab-table {
        table-layout: auto;
        width: auto;
        min-width: 600px;
        max-width: none;
      }
      .investment-tab-table th, .investment-tab-table td {
        white-space: nowrap;
        text-align: center;
        vertical-align: middle;
        min-width: 200px; /* Further increased for full data display */
      }
      .investment-tab-table input.form-control {
        width: 100%;
        min-width: 200px;
        display: block;
        box-sizing: border-box;
      }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>Projects</h1>
        <a href="/" class="btn btn-secondary mt-3">&larr; Back to Home</a>
        <p class="mt-4">This is a placeholder for the Projects page.</p>
        <button class="btn btn-primary mt-4" data-bs-toggle="modal" data-bs-target="#searchModal">Search Projects</button>
    </div>

    <!-- Tabbed project view -->
    <div class="container mt-4">
      <ul class="nav nav-tabs" id="projectTabs" role="tablist"></ul>
      <div class="tab-content" id="projectTabContent"></div>
    </div>

    <!-- Search Modal with fields -->
    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="searchModalLabel">Search Projects</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>          <div class="modal-body">
            <form id="search-projects-form">
              <div class="alert alert-info">
                Enter search criteria to filter projects. Leave all fields empty to view all projects.
              </div>
              {% for field in project_fields %}
                <div class="mb-3">
                  <label for="search-{{ field }}" class="form-label">{{ field.replace('_', ' ').title() }}</label>
                  <input type="text" class="form-control" id="search-{{ field }}" name="{{ field }}" placeholder="Enter {{ field.replace('_', ' ').title() }}">
                </div>
              {% endfor %}
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="search-projects-btn">Search</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="resultsModalLabel">Search Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="select-projects-form">
              <div id="search-results-container">
                <!-- Results will be injected here -->
              </div>
              <button type="submit" class="btn btn-primary mt-3">Open Selected</button>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Investment/Depreciation Edit Modal -->
    <div class="modal fade" id="investmentModal" tabindex="-1" aria-labelledby="investmentModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="investmentModalLabel">Edit Investments & Depreciation</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="investment-modal-form">
              <div id="investment-modal-table-wrapper">
                <div id="investment-modal-table"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="save-investment-modal-btn">Save</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>    <script>    // Function to clean up modal backdrops and fix UI state
    function cleanupModalBackdrops() {
      console.log('Cleaning up modal backdrops...');
      
      // Remove any modal backdrops
      const modalBackdrops = document.querySelectorAll('.modal-backdrop');
      modalBackdrops.forEach(backdrop => {
        console.log('Removing backdrop:', backdrop);
        backdrop.remove();
      });
      
      // Reset body styles
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
      
      // Additional forceful cleanup
      document.body.style.removeProperty('overflow');
      document.body.style.removeProperty('padding-right');
      
      console.log('Cleanup completed');
    }
    
    // Make project_fields available in JS (Jinja2 block for correct placement)
    var projectFields = {{ project_fields | tojson | safe }};    // Add event listeners to all modals to handle backdrop cleanup on close    document.addEventListener('DOMContentLoaded', function() {
      // Override Bootstrap's modal hide method to ensure proper cleanup
      const originalHide = bootstrap.Modal.prototype.hide;
      bootstrap.Modal.prototype.hide = function() {
        console.log('Modal hide method called - applying custom cleanup');
        // Call the original hide method
        originalHide.apply(this, arguments);
        // Schedule our cleanup
        setTimeout(cleanupModalBackdrops, 150);
      };
      
      // Set up listeners for each modal
      ['searchModal', 'resultsModal', 'investmentModal'].forEach(modalId => {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
          // Listen for when the modal starts to hide
          modalElement.addEventListener('hide.bs.modal', function(event) {
            console.log(`Modal ${modalId} hide event triggered`);
            // Schedule cleanup
            setTimeout(cleanupModalBackdrops, 50);
          });
          
          // Listen for when the modal is completely hidden
          modalElement.addEventListener('hidden.bs.modal', function(event) {
            console.log(`Modal ${modalId} hidden event triggered`);
            // Schedule cleanup
            setTimeout(cleanupModalBackdrops, 150);
          });
          
          // Add direct click handler for backdrop clicks
          modalElement.addEventListener('click', function(event) {
            // Check if the click was on the modal container itself (not its children)
            if (event.target === modalElement) {
              console.log(`Backdrop click detected on ${modalId}`);
              setTimeout(cleanupModalBackdrops, 50);
            }
          });
        }
      });
      
      // Global backdrop click handler
      document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal-backdrop')) {
          console.log('Direct backdrop click detected');
          setTimeout(cleanupModalBackdrops, 50);
        }
      });
        // Add escape key handler
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          console.log('Escape key pressed');
          setTimeout(cleanupModalBackdrops, 150);
        }
      });
      
      // Global window click handler for any modal-related element
      window.addEventListener('click', function(event) {
        // Check if the clicked element or any parent has modal-related classes
        let target = event.target;
        while (target && target !== document) {
          if (target.classList && 
              (target.classList.contains('modal') || 
               target.classList.contains('modal-backdrop') ||
               target.classList.contains('modal-dialog'))) {
            console.log('Modal-related element clicked');
            setTimeout(cleanupModalBackdrops, 50);
            break;
          }
          target = target.parentNode;
        }
      }, true); // Use capturing phase to handle events before they reach other handlers
    
    
    // Search and display results with checkboxes
    document.getElementById('search-projects-btn').addEventListener('click', function() {
      // Clean up any existing modal backdrops before starting
      cleanupModalBackdrops();
      
      const form = document.getElementById('search-projects-form');
      const formData = new FormData(form);
      const params = new URLSearchParams();
      
      for (const [key, value] of formData.entries()) {
        if (value.trim()) {
          params.append(key, value);
        }
      }
      
      // Show loading indicator
      document.getElementById('search-results-container').innerHTML = 
        '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p>Searching...</p></div>';
      const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
      resultsModal.show();
      
      fetch(`/search-projects?${params.toString()}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Server returned status ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })        .then(data => {
          let html = '';
          if (!Array.isArray(data) || data.length === 0) {
            html = '<div class="alert alert-warning">No projects found.</div>';
          } else {
            html += '<table class="table table-bordered"><thead><tr><th></th>';
            projectFields.forEach(function(field) {
              html += `<th>${field.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`;
            });
            html += '</tr></thead><tbody>';            data.forEach(function(proj) {
              if (typeof proj !== 'object' || proj === null) return;
              html += '<tr>';
              html += `<td><input type="checkbox" name="project_id" value="${proj.project_id || ''}"></td>`;
              projectFields.forEach(function(field) {
                html += `<td>${proj[field] || ''}</td>`;
              });
              html += '</tr>';
            });
            html += '</tbody></table>';
          }
          document.getElementById('search-results-container').innerHTML = html;
          // Hide the search modal only after results are ready
          const searchModal = bootstrap.Modal.getInstance(document.getElementById('searchModal'));
          if (searchModal) {
            searchModal.hide();
            // Ensure backdrop is removed from search modal too
            setTimeout(() => {
              cleanupModalBackdrops();
            }, 150);
          }
          const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
          resultsModal.show();
        })        .catch(err => {
          console.error('Search error:', err);
          document.getElementById('search-results-container').innerHTML = 
            '<div class="alert alert-danger">Error fetching results: ' + err.message + '</div>';
          // Ensure the results modal is showing the error
          const resultsModal = bootstrap.Modal.getInstance(document.getElementById('resultsModal')) || 
                               new bootstrap.Modal(document.getElementById('resultsModal'));
          resultsModal.show();
          
          // Ensure backdrop is properly managed
          setTimeout(cleanupModalBackdrops, 150);
        });    });    // Handle opening selected projects in tabs
    document.getElementById('select-projects-form').addEventListener('submit', function(e) {
      e.preventDefault();
      console.log('Form submitted, processing selection...');
      
      const checked = Array.from(document.querySelectorAll('#search-results-container input[name="project_id"]:checked')).map(cb => cb.value);
      if (checked.length === 0) {
        alert('No projects selected.');
        return;
      }
        // Close results modal first to prevent UI freezing
      const resultsModal = bootstrap.Modal.getInstance(document.getElementById('resultsModal'));
      if (resultsModal) {
        console.log('Hiding results modal...');
        resultsModal.hide();
      }
      
      // Forceful cleanup of modals
      cleanupModalBackdrops();
      
      // Add a larger delay before opening tabs to ensure modal is fully closed
      setTimeout(() => {
        console.log('Opening project tabs...');
        // For each selected project, fetch details and open in a tab
        checked.forEach(projectId => {
          openProjectTab(projectId);
        });
        
        // Final cleanup to ensure no backdrop remains
        setTimeout(cleanupModalBackdrops, 300);
      }, 500);
    });

    // Add emergency cleanup mechanism - double click on page background fixes UI
    document.addEventListener('dblclick', function(event) {
      // Only respond to clicks directly on the body background
      if (event.target === document.body) {
        console.log('Emergency cleanup triggered via double-click');
        cleanupModalBackdrops();
      }
    });
    
    // Tab management
    function openProjectTab(projectId) {
      // If tab already exists, activate it
      if (document.getElementById('tab-' + projectId)) {
        const tab = new bootstrap.Tab(document.getElementById('tab-' + projectId));
        tab.show();
        return;
      }
      // Fetch project details (reuse search endpoint for demo, ideally have a /project/<id> endpoint)
      fetch(`/search-projects?project_id=${projectId}`)
        .then(response => response.json())
        .then(data => {
          const proj = Array.isArray(data) ? data[0] : data;
          if (!proj) return;
          // Add tab
          const tabId = 'tab-' + projectId;
          const contentId = 'tab-content-' + projectId;
          const tabList = document.getElementById('projectTabs');
          const tabContent = document.getElementById('projectTabContent');          // Tab
          const tabLi = document.createElement('li');
          tabLi.className = 'nav-item';
          tabLi.innerHTML = `<button class="nav-link" id="${tabId}" data-bs-toggle="tab" data-bs-target="#${contentId}" type="button" role="tab" aria-controls="${contentId}" aria-selected="false">Project ${proj.project_id || ''} <span class="ms-2 text-danger" style="cursor:pointer;" onclick="event.stopPropagation(); closeProjectTab('${projectId}');">&times;</span></button>`;
          tabList.appendChild(tabLi);
          // Content
          const tabPane = document.createElement('div');
          tabPane.className = 'tab-pane fade';
          tabPane.id = contentId;
          tabPane.setAttribute('role', 'tabpanel');          tabPane.innerHTML = `
            <form class="mt-3" onsubmit="saveProject(event, '${projectId}')">
              <div class="mb-3"><label>Project Id</label><input class="form-control" name="project_id" value="${proj.project_id || ''}" readonly></div>
              <div class="mb-3"><label>Branch</label><input class="form-control" name="branch" value="${proj.branch || ''}"></div>
              <div class="mb-3"><label>Operations</label><input class="form-control" name="operations" value="${proj.operations || ''}"></div>
              <div class="mb-3"><label>Description</label><input class="form-control" name="description" value="${proj.description || ''}"></div>
              <div class="mb-3"><label>Depreciation Method</label><input class="form-control" name="depreciation_method" value="${proj.depreciation_method || ''}"></div>
              <div class="mb-3"><label>Cost Center</label><input class="form-control" name="cost_center" value="${proj.cost_center || ''}"></div>
              <hr>
              <h5>Investments & Depreciation Starts</h5>              <div id="investment-table-${projectId}"></div>
              <button type="button" class="btn btn-outline-primary mt-2" onclick="openInvestmentModal('${projectId}')">Edit Investments/Depreciation</button>
              <div id="depreciation-buttons-${projectId}" class="mt-3">
                <!-- Depreciation buttons will be loaded here -->
              </div>
              <button type="submit" class="btn btn-success mt-3 ms-2">Save Changes</button>
              <button type="button" class="btn btn-danger ms-2" onclick="deleteProject('${projectId}')">Delete Project</button>
            </form>
          `;
          tabContent.appendChild(tabPane);          // Fetch investments and render table
          fetch(`/project-investments/${projectId}`)
            .then(response => response.json())
            .then(investments => {
              renderInvestmentTableForProject(projectId, investments, true); // true = read-only
            });
            // Load depreciation buttons
          loadDepreciationButtons(projectId);
          
          // Activate new tab after a short delay to ensure DOM is updated
          setTimeout(() => {
            try {
              const tabButton = document.getElementById(tabId);
              if (tabButton) {
                const tab = new bootstrap.Tab(tabButton);
                tab.show();
              }
            } catch (err) {
              console.error('Error activating tab:', err);
            }
          }, 100);
        })
        .catch(err => {
          console.error('Error opening project tab:', err);
          alert('Failed to open project tab: ' + err.message);
        });
    }    // Close tab function
    window.closeProjectTab = function(projectId) {
      const tabId = 'tab-' + projectId;
      const contentId = 'tab-content-' + projectId;
      const tabBtn = document.getElementById(tabId);
      const tabPane = document.getElementById(contentId);
      
      // Check if the tab being closed is active
      const isActive = tabBtn && tabBtn.classList.contains('active');
      
      // Remove the tab and content
      if (tabBtn) tabBtn.parentElement.remove();
      if (tabPane) tabPane.remove();
      
      // Only activate another tab if the closed tab was active
      if (isActive) {
        const firstTab = document.querySelector('#projectTabs .nav-link');
        if (firstTab) {
          try {
            const tab = new bootstrap.Tab(firstTab);
            tab.show();
          } catch (err) {
            console.error('Error activating tab after close:', err);
          }
        }
      }
    }

    // Save project changes (placeholder, implement backend as needed)
    window.saveProject = function(event, projectId) {
      event.preventDefault();
      const form = event.target;
      const data = Object.fromEntries(new FormData(form).entries());
      // TODO: Implement backend update endpoint
      alert('Saving project ' + projectId + ':\n' + JSON.stringify(data, null, 2));
    }

    // Delete project (placeholder, implement backend as needed)
    window.deleteProject = function(projectId) {
      if (!confirm('Are you sure you want to delete project ' + projectId + '?')) return;
      // TODO: Implement backend delete endpoint
      alert('Deleting project ' + projectId);
      closeProjectTab(projectId);
    }

    // Investment & Depreciation Table for Project Tab
    function renderInvestmentTableForProject(projectId, investments = [], readOnly = false) {
      const years = investments.years || investments.years || [];
      const data = investments.investments || investments || [];
      const invMap = {};
      const deprStartMap = {};
      const deprMonthMap = {};
      data.forEach(inv => {
        if (inv.investment_amount !== undefined && inv.investment_amount !== null) {
          invMap[inv.year] = inv.investment_amount;
        }
        if (inv.start_year !== undefined && inv.start_year !== null) {
          deprStartMap[inv.year] = true;
          if (inv.month !== undefined && inv.month !== null) {
            deprMonthMap[inv.year] = inv.month;
          }
        }
      });
      let html = '<div class="investment-tab-table-wrapper">';
      html += '<table class="table table-bordered text-center investment-tab-table">';
      html += '<thead><tr>';
      years.forEach(year => {
        html += `<th>${year}</th>`;
      });
      html += '</tr></thead><tbody>';
      // Investment row
      html += '<tr>';
      years.forEach(year => {
        html += `<td><input type="number" class="form-control" name="investment_${year}" placeholder="Investment" value="${invMap[year] ?? ''}" ${readOnly ? 'readonly tabindex="-1"' : ''}></td>`;
      });
      html += '</tr>';
      // Depreciation start year row (tickboxes)
      html += '<tr>';
      years.forEach(year => {
        html += `<td><input type="checkbox" class="form-check-input" name="depr_start_${year}" ${deprStartMap[year] ? 'checked' : ''} ${readOnly ? 'disabled tabindex="-1"' : ''}></td>`;
      });
      html += '</tr>';
      // Depreciation start month row (input only if ticked)
      html += '<tr>';
      years.forEach(year => {
        html += `<td id="month-cell-${projectId}-${year}">`;
        if (deprStartMap[year]) {
          html += `<input type="number" min="1" max="12" class="form-control" name="depr_month_${year}" placeholder="Month" value="${deprMonthMap[year] ?? ''}" ${readOnly ? 'readonly tabindex="-1"' : ''}>`;
        }
        html += '</td>';
      });
      html += '</tr>';
      html += '</tbody></table></div>';
      document.getElementById(`investment-table-${projectId}`).innerHTML = html;
    }
    window.toggleMonthInputForProject = function(projectId, year, checked) {
      const cell = document.getElementById(`month-cell-${projectId}-${year}`);
      if (checked) {
        cell.innerHTML = `<input type="number" min="1" max="12" class="form-control" name="depr_month_${year}" placeholder="Month">`;
      } else {
        cell.innerHTML = '';
      }
    }

    // Modal logic
    window.openInvestmentModal = function(projectId) {
      // Fetch data and populate modal
      fetch(`/project-investments/${projectId}`)
        .then(response => response.json())
        .then(data => {
          renderInvestmentModalTable(projectId, data);
          // Store projectId for save
          document.getElementById('investmentModal').setAttribute('data-project-id', projectId);
          const modal = new bootstrap.Modal(document.getElementById('investmentModal'));
          modal.show();
        });
    }
    // In renderInvestmentModalTable, set table id for CSS
    function renderInvestmentModalTable(projectId, data) {
      const years = data.years || [];
      const investments = data.investments || [];
      const invMap = {};
      const deprStartMap = {};
      const deprMonthMap = {};
      investments.forEach(inv => {
        if (inv.investment_amount !== undefined && inv.investment_amount !== null) {
          invMap[inv.year] = inv.investment_amount;
        }
        if (inv.start_year !== undefined && inv.start_year !== null) {
          deprStartMap[inv.year] = true;
          if (inv.month !== undefined && inv.month !== null) {
            deprMonthMap[inv.year] = inv.month;
          }
        }
      });
      let html = '<table class="table table-bordered text-center" id="investment-modal-table-table"><thead><tr>';
      years.forEach(year => {
        html += `<th>${year}</th>`;
      });
      html += '</tr></thead><tbody>';
      // Investment row
      html += '<tr>';
      years.forEach(year => {
        html += `<td><input type="number" class="form-control" name="investment_${year}" placeholder="Investment" value="${invMap[year] ?? ''}"></td>`;
      });
      html += '</tr>';
      // Depreciation start year row (tickboxes)
      html += '<tr>';
      years.forEach(year => {
        html += `<td><input type="checkbox" class="form-check-input" name="depr_start_${year}" onchange="toggleMonthInputModal(${year}, this.checked)" ${deprStartMap[year] ? 'checked' : ''}></td>`;
      });
      html += '</tr>';
      // Depreciation start month row (input only if ticked)
      html += '<tr>';
      years.forEach(year => {
        html += `<td id="modal-month-cell-${year}">`;
        if (deprStartMap[year]) {
          html += `<input type="number" min="1" max="12" class="form-control" name="depr_month_${year}" placeholder="Month" value="${deprMonthMap[year] ?? ''}">`;
        }
        html += '</td>';
      });
      html += '</tr>';
      html += '</tbody></table>';
      document.getElementById('investment-modal-table').innerHTML = html;
    }
    window.toggleMonthInputModal = function(year, checked) {
      const cell = document.getElementById(`modal-month-cell-${year}`);
      if (checked) {
        cell.innerHTML = `<input type="number" min="1" max="12" class="form-control" name="depr_month_${year}" placeholder="Month">`;
      } else {
        cell.innerHTML = '';
      }
    }

    // Save button handler (ready for backend integration)
    document.getElementById('save-investment-modal-btn').addEventListener('click', function() {
      const form = document.getElementById('investment-modal-form');
      const data = Object.fromEntries(new FormData(form).entries());
      const projectId = document.getElementById('investmentModal').getAttribute('data-project-id');
      // Send data to backend endpoint for saving
      fetch(`/api/projects/${projectId}/save-investments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          alert('Investments and depreciation data saved!');
        } else {
          alert('Error saving data: ' + (result.error || 'Unknown error'));
        }
        // Optionally close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('investmentModal'));
        if (modal) modal.hide();
        // Refresh the tab table if open
        const tabTableDiv = document.getElementById(`investment-table-${projectId}`);
        if (tabTableDiv) {
          fetch(`/project-investments/${projectId}`)
            .then(response => response.json())
            .then(investments => {
              renderInvestmentTableForProject(projectId, investments, true);
            });
        }
      })
      .catch(error => {
        alert('Network or server error: ' + error);
      });
    });

    // Functions for depreciation calculations
    function loadDepreciationButtons(projectId) {
      // Check if project has calculated depreciations
      fetch(`/api/projects/${projectId}/has-calculated-depreciations`)
        .then(response => response.json())
        .then(data => {
          const buttonContainer = document.getElementById(`depreciation-buttons-${projectId}`);
          if (buttonContainer) {
            if (data.has_calculated_depreciations) {
              buttonContainer.innerHTML = `
                <button type="button" class="btn btn-warning" onclick="recalculateDepreciations('${projectId}')">
                  Recalculate Depreciations
                </button>`;
            } else {
              buttonContainer.innerHTML = `
                <button type="button" class="btn btn-primary" onclick="calculateDepreciations('${projectId}')">
                  Calculate Depreciations
                </button>`;
            }
          }
        })
        .catch(error => console.error('Error loading depreciation buttons:', error));
    }    function calculateDepreciations(projectId) {
      if (!confirm('Are you sure you want to calculate depreciations for this project?')) return;
      // Show loading indicator
      const buttonContainer = document.getElementById(`depreciation-buttons-${projectId}`);
      if (buttonContainer) {
        buttonContainer.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
      }
      // Call API to calculate
      fetch(`/api/projects/${projectId}/calculate-depreciations`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(`Depreciations calculated successfully!\n\nDebug info: Method type is "${data.method_type}"`);
        } else {
          alert(`Failed to calculate depreciations:\n${data.error || 'Unknown error'}`);
        }
        loadDepreciationButtons(projectId);
      })
      .catch(error => {
        alert('An error occurred while calculating depreciations.');
        loadDepreciationButtons(projectId);
      });
    }    function recalculateDepreciations(projectId) {
      if (!confirm('Are you sure you want to recalculate depreciations for this project? This will delete all existing calculations.')) return;
      
      // Show loading indicator
      const buttonContainer = document.getElementById(`depreciation-buttons-${projectId}`);
      if (buttonContainer) {
        buttonContainer.innerHTML = '<div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div>';
      }
      
      // Call API
      fetch(`/api/projects/${projectId}/recalculate-depreciations`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(async response => {
        let data;
        try {
          data = await response.json();
        } catch (err) {
          const text = await response.text();
          throw new Error(`Server error: ${response.status} ${response.statusText}\n${text}`);
        }
        return data;
      })
      .then(data => {
        if (data.success) {
          console.log('Recalculation result:', data);
          alert(`Depreciations recalculated successfully!\n\nDebug info: Method type is "${data.method_type}"`);
          loadDepreciationButtons(projectId);
        } else {
          alert('Failed to recalculate depreciations: ' + (data.error || 'Unknown error'));
          loadDepreciationButtons(projectId);
        }
      })
      .catch(error => {
        console.error('Error recalculating depreciations:', error);
        alert('An error occurred while recalculating depreciations.\n' + error);
        loadDepreciationButtons(projectId);
      });
    }
    </script>
</body>
</html>
